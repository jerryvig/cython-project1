<!doctype html>
<html>
<head>
	<title>FastCGI testing</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<style type="text/css">
		body {
			width: 100%;
		}

		#data-table {
			display: block;
			width: 80%;
			margin:0 auto;
		}

		th, td {
			padding: 6px;
		}

		th:hover {
			background-color: #ADDFFF;
		}

		.text-cell {
			text-align: left;
		}

		.numeric-cell {
			text-align: right;
		}

		.remove-cell {
			text-align: center;
			font-weight: bold;
		}

		#ticker-input {
			display: block;
			margin: 0 auto;
		}
	</style>
</head>
<body>
	<table id="data-table">
		<thead>
			<tr>
				<th>Remove Row</th>
				<th id="ticker-col">Ticker</th>
				<th id="title-col">Title</th>
				<th id="change-col">Change</th>
				<th id="record-count-col">Record Count</th>
				<th id="self-correlation-col">Self Correlation</th>
				<th id="sigma-col">Sigma</th>
				<th id="sigma-change-col">Sigma Change</th>
				<th id="top-10-down-col">Top 10 Down</th>
				<th id="top-10-up-col">Top 10 Up</th>
				<th id="avg-10-down-col">Avg Move Top 10 Down</th>
				<th id="avg-10-up-col">Avg Move Top 10 Up</th>
			</tr>
		</thead>
		<tbody id="data-table-body"></tbody>
		<tfoot>
			<tr>
				<td colspan="12">
					<input id="ticker-input" type="text" placeholder="Enter ticker symbol here"></input>
				</td>
			</tr>
		</tfoot>
	</table>
</body>
<script type="text/javascript">
	let gridData = {};
	let rowIndex = 0;

	const addDataRow = (data) => {
		gridData[rowIndex] = data;

		const nextTableRow = document.createElement('tr');
		nextTableRow.id = `row-${rowIndex}`
		nextTableRow.innerHTML = `<td class="remove-cell" id="close-row-${rowIndex}">&times;</td>\
			<td class="text-cell">${data.resp_ticker}</td>\
			<td class="text-cell">${data.title}</td>\
			<td class="numeric-cell">${data.change}</td>\
			<td class="numeric-cell">${data.record_count}</td>\
			<td class="numeric-cell">${data.self_correlation}</td>\
			<td class="numeric-cell">${data.sigma}</td>\
			<td class="numeric-cell">${data.sigma_change}</td>\
			<td class="numeric-cell">${data.sign_diff_pct_10_down}</td>\
			<td class="numeric-cell">${data.sign_diff_pct_10_up}</td>\
			<td class="numeric-cell">${data.avg_move_10_down}</td>\
			<td class="numeric-cell">${data.avg_move_10_up}</td>`;
		document.getElementById('data-table-body').appendChild(nextTableRow);

		const closeId = `close-row-${rowIndex}`;
		document.querySelector(`#${closeId}`).addEventListener('click', (evt) => {
			let targetId = evt.target.id;
			let rowIdx = targetId.replace('close-row-', '');
			delete gridData[rowIdx];
			$('#' + closeId).parent().remove();
		});
		rowIndex++;
	};

	document.querySelector('#ticker-input').addEventListener('change', (evt) => {
		const ticker = evt.target.value;
		const url = `/compute_statistics/${ticker}`;
		fetch(url).then(response => response.json()).then((data) => {
			addDataRow(data);
			document.getElementById('ticker-input').value = '';
		});
	});

	let tickerSortDirection = 1;
	const sortByTicker = () => {
		let gridDataArray = [];
		for (const idx in gridData) {
			gridDataArray.push(gridData[idx]);
		}

		gridDataArray.sort((a, b) => {
			var tickerA = a.resp_ticker;
			var tickerB = b.resp_ticker;

			if (tickerA > tickerB) {
				return 1 * tickerSortDirection;
			} else if (tickerB > tickerA) {
				return -1 * tickerSortDirection;
			} else {
				return 0;
			}
		});
		tickerSortDirection *= -1;

		gridData = {};
		rowIndex = 0;
		$('#data-table-body').empty();
		for (let row of gridDataArray) {
			addDataRow(row);
			rowIndex++;
		}
	};

	let titleSortDirection = 1;
	const sortByTitle = () => {
		let gridDataArray = [];
		for (const idx in gridData) {
			gridDataArray.push(gridData[idx]);
		}

		gridDataArray.sort((a, b) => {
			if (a.title > b.title) {
				return 1 * titleSortDirection;
			} else if (b.title > a.title) {
				return -1 * titleSortDirection;
			} else {
				return 0;
			}
		});
		titleSortDirection *= -1;
	};

	document.querySelector('#ticker-col').addEventListener('click', sortByTicker);

	document.querySelector('#title-col').addEventListener('click', (evt) => {
		// do the sort by title here.
	});

	document.querySelector('#self-correlation-col').addEventListener('click', (evt) => {
		// do the sort by self correlation here.
	});

	document.querySelector('#change-col').addEventListener('click', (evt) => {
		// do the sort by change here.
	});

	document.querySelector('#record-count-col').addEventListener('click', (evt) => {
		// do the sort by record count here.
	});

	document.querySelector('#sigma-col').addEventListener('click', (evt) => {
		// do the sort by sigma here.
	});

	document.querySelector('#sigma-change-col').addEventListener('click', (evt) => {
		// do the sort by sigma here.
		alert('you clicked the sigma-change-col');
	});
</script>
</html>